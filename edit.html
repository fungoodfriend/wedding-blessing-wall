<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>管理留言</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>
  <h2>留言管理介面</h2>
  <div id="user-info" style="margin-bottom: 10px;"></div>
  <button id="loginBtn">使用 Google 登入</button>
  <button id="logoutBtn" style="display: none;">登出</button>

  <div id="messages"></div>

  <script>
    // Firebase 設定
    const firebaseConfig = {
      apiKey: "AIzaSyB8unHbn_jO7tuteLOUPy9t4-4gEL-GHcM",
      authDomain: "wedding-blessing-wall.firebaseapp.com",
      projectId: "wedding-blessing-wall",
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // 管理者 email 清單（只有這些帳號可以刪留言）
    const allowedAdmins = ["fungoodfriend@gmail.com"]; // << 替換成你的 Google 信箱

    // DOM
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const userInfo = document.getElementById("user-info");
    const messagesDiv = document.getElementById("messages");

    loginBtn.onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider);
    };

    logoutBtn.onclick = () => auth.signOut();

    auth.onAuthStateChanged(user => {
      if (user) {
        const email = user.email;
        userInfo.innerText = `登入中：${email}`;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";

        if (allowedAdmins.includes(email)) {
          loadMessages();
        } else {
          messagesDiv.innerHTML = "<p style='color:red;'>您不是管理者，無權進行操作。</p>";
        }
      } else {
        userInfo.innerText = "尚未登入";
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        messagesDiv.innerHTML = "";
      }
    });

    function loadMessages() {
      db.collection("messages").orderBy("timestamp", "desc").get().then(snapshot => {
        let html = "";
        snapshot.forEach(doc => {
          const msg = doc.data();
          html += `
            <div style="border: 1px solid #ccc; padding: 10px; margin: 10px;">
              <strong>${msg.author}</strong><br>
              ${msg.text}<br>
              <button onclick="deleteMessage('${doc.id}')">刪除</button>
            </div>
          `;
        });
        messagesDiv.innerHTML = html;
      });
    }

    function deleteMessage(id) {
      if (confirm("確定要刪除這則留言？")) {
        db.collection("messages").doc(id).delete().then(() => {
          alert("刪除成功！");
          loadMessages();
        }).catch(err => {
          alert("刪除失敗：" + err.message);
        });
      }
    }
  </script>
</body>
</html>
